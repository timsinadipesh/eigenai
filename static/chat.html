<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>frende - Chat</title>
    <script src="./js/markdown-it.min.js"></script> 
    <script src="./js/chat-template.js"></script>
    <style>
        /* Settings Modal Styles */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .settings-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .settings-content h2 {
            margin: 0 0 1rem 0;
            font-size: 1.5rem;
            color: #333;
        }
        
        .settings-content label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }
        
        .settings-content textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            box-sizing: border-box;
        }
        
        .settings-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }
        
        .settings-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .settings-btn.primary {
            background: #007bff;
            color: white;
        }
        
        .settings-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .settings-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>


    <script>
        // Simple Chat Implementation using ChatTemplate
        class SimpleChatApp extends ChatTemplate {
            constructor() {
                super({
                    modeText: 'CHAT',
                    backUrl: '/',
                    welcomeTitle: 'Chat with frende',
                    welcomeSubtitle: 'Your private on-device AI companion',
                    placeholder: 'Type your message...',
                    
                    // Enable all features for chat
                    enableTTS: true,
                    enableAttachments: true,
                    enableAudio: true,
                    enableSettings: true,
                    
                    // Settings callback
                    onSettingsClick: () => {
                        openSettings();
                    }
                });
                
                // Store system message
                this.systemMessage = '';
                this.loadSystemMessage();
            }

            // Override initialize to inject settings modal after ChatTemplate initialization
            async initialize() {
                await super.initialize();
                this.injectSettingsModal();
            }

            // Inject settings modal into DOM
            injectSettingsModal() {
                const modalHTML = `
                    <div id="settingsModal" class="settings-modal">
                        <div class="settings-content">
                            <label for="systemMessage">System Message:</label>
                            <textarea 
                                id="systemMessage" 
                                placeholder="Enter system message for frende to follow"
                            ></textarea>
                            <div class="settings-actions">
                                <button class="settings-btn secondary" onclick="closeSettings()">Cancel</button>
                                <button class="settings-btn primary" onclick="saveSettings()">Save</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // Load system message from localStorage
            loadSystemMessage() {
                this.systemMessage = localStorage.getItem('systemMessage') || '';
            }

            // Save system message to localStorage
            saveSystemMessage() {
                localStorage.setItem('systemMessage', this.systemMessage);
            }

            // Override message processing to prepend system message
            processMessage(message) {
                if (!this.systemMessage.trim()) {
                    return message;
                }
                
                // If message has text content, prepend system message with ": "
                if (message.trim()) {
                    return `${this.systemMessage}: ${message}`;
                } else {
                    // If only non-text modalities, return system message as is
                    return this.systemMessage;
                }
            }
        }

        let chatApp;

        // Settings Modal Functions
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const textarea = document.getElementById('systemMessage');
            
            // Load current system message
            textarea.value = chatApp.systemMessage;
            modal.classList.add('active');
            
            // Focus on textarea
            setTimeout(() => textarea.focus(), 100);
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('active');
        }

        function saveSettings() {
            const textarea = document.getElementById('systemMessage');
            chatApp.systemMessage = textarea.value;
            chatApp.saveSystemMessage();
            closeSettings();
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('settingsModal');
            if (e.target === modal) {
                closeSettings();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSettings();
            }
        });

        // Initialize the chat app when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            chatApp = new SimpleChatApp();
            await chatApp.initialize();
            
            // Handle transition data from landing page if present
            chatApp.handleTransitionData();
        });
    </script>
</body>
</html>